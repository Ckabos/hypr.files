#!/usr/bin/env bash

# Script: cava
# Propósito:
# Visualizador de audio para Waybar utilizando cava con salida raw ascii y conversión de niveles a caracteres.

# ==============================
# Configuración de caracteres de barra
bar="▁▂▃▄▅▆▇█"
dict="s/;//g"  # Inicializa el diccionario de sustitución

# Calcular longitud de la barra
bar_length=${#bar}

# Crear diccionario sed para reemplazar números (0-7) con caracteres
for ((i = 0; i < bar_length; i++)); do
    dict+=";s/$i/${bar:$i:1}/g"
done

# ==============================
# Generar archivo temporal de configuración de cava
config_file="/tmp/bar_cava_config"

cat >"$config_file" <<EOF
[general]
bars = 10

[input]
method = pulse
source = auto

[output]
method = raw
raw_target = /dev/stdout
data_format = ascii
ascii_max_range = 7
EOF

# ==============================
# Finalizar instancias previas de cava usando este config
pkill -f "cava -p $config_file"

# ==============================
# Ejecutar cava y reemplazar números con caracteres de barra en tiempo real
cava -p "$config_file" | sed -u "$dict"

